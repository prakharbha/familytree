// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  VIEWER
  CONTRIBUTOR
  LEGACY_KEEPER
}

enum RelationshipType {
  PARENT
  CHILD
  SIBLING
  SPOUSE
  GRANDPARENT
  GRANDCHILD
  AUNT_UNCLE
  NIECE_NEPHEW
  COUSIN
}

enum ConnectionRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  MEMORY_CAPSULE
  WALL_ITEM
  FAMILY_UPDATE
  CONNECTION_REQUEST
  CHAT_MESSAGE
}

enum PersonaType {
  PERSONAL
  PROFESSIONAL
  SOCIAL
  GENERATIONAL
  SPIRITUAL
  CULTURAL
}

enum Visibility {
  PRIVATE
  FAMILY
  CONTRIBUTORS
  PUBLIC
}

enum MediaType {
  PHOTO
  VIDEO
  AUDIO
  DOCUMENT
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  profile   Profile?

  @@map("users")
}

model Profile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  photo       String?
  coverPhoto  String?
  name        String
  dateOfBirth DateTime?
  bio         String?
  location    String?
  profession  String?
  
  // The Six Personas
  personas    Persona[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  memoryCapsules         MemoryCapsule[]
  legacyWallItems        LegacyWallItem[]
  legacyVaultItems       LegacyVaultItem[]
  traditions             Tradition[]
  feedPosts              FeedPost[]
  familyRelations        FamilyMember[] @relation("FamilyRelations")
  relatedFamilyMembers   FamilyMember[]
  sentConnectionRequests FamilyConnectionRequest[] @relation("SenderRequests")
  receivedConnectionRequests FamilyConnectionRequest[] @relation("ReceiverRequests")
  chatConversationsAsUser1 ChatConversation[] @relation("User1")
  chatConversationsAsUser2 ChatConversation[] @relation("User2")
  sentMessages           ChatMessage[] @relation("Sender")

  notifications          Notification[]
  feedComments           FeedComment[]
  mediaItems             MediaItem[]
  receivedVaultItems     LegacyVaultItem[] @relation("DesignatedViewer")

  @@map("profiles")
}

model Persona {
  id          String      @id @default(uuid())
  profileId   String
  profile     Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  type        PersonaType
  description String?
  highlights  String[]    @default([])
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([profileId, type])
  @@map("personas")
}

model FamilyConnectionRequest {
  id             String                 @id @default(uuid())
  senderId       String
  sender         Profile                @relation("SenderRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId     String
  receiver       Profile                @relation("ReceiverRequests", fields: [receiverId], references: [id], onDelete: Cascade)
  relationshipType RelationshipType
  status         ConnectionRequestStatus @default(PENDING)
  message        String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@unique([senderId, receiverId, relationshipType])
  @@map("family_connection_requests")
}

model FamilyMember {
  id               String           @id @default(uuid())
  profileId        String
  profile          Profile          @relation(fields: [profileId], references: [id], onDelete: Cascade)
  relatedProfileId String
  relatedProfile   Profile          @relation("FamilyRelations", fields: [relatedProfileId], references: [id], onDelete: Cascade)
  relationshipType RelationshipType
  role             UserRole         @default(VIEWER)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([profileId, relatedProfileId, relationshipType])
  @@map("family_members")
}

model MemoryCapsule {
  id          String   @id @default(uuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  title       String
  description String?  // Story
  date        DateTime? // Can be just a year, so maybe handle loosely or specific date
  
  personaTags PersonaType[]
  emotionalTags String[] @default([])
  lesson      String?
  
  visibility  Visibility @default(FAMILY)
  
  mediaItems  MediaItem[]
  
  comments    FeedComment[]
  reactions   FeedReaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("memory_capsules")
}

model LegacyWallItem {
  id          String   @id @default(uuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  title       String
  category    PersonaType
  description String?
  lesson      String?
  
  mediaItems  MediaItem[]
  
  visibility  Visibility @default(FAMILY)
  
  comments    FeedComment[]
  reactions   FeedReaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("legacy_wall_items")
}

model LegacyVaultItem {
  id          String   @id @default(uuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  title       String
  type        String   // letter, key, instruction, document
  description String?
  fileUrl     String?
  
  accessRules String?  // JSON or string description of who can access
  isLocked    Boolean  @default(true)
  
  unlockAt           DateTime?
  designatedViewerId String?
  designatedViewer   Profile?  @relation("DesignatedViewer", fields: [designatedViewerId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("legacy_vault_items")
}

model Tradition {
  id          String   @id @default(uuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  name        String
  origin      String?
  description String?
  
  mediaItems  MediaItem[]
  
  comments    FeedComment[]
  reactions   FeedReaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("traditions")
}

model FeedPost {
  id          String   @id @default(uuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  content     String
  mediaUrls   String[] @default([])
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  comments    FeedComment[]
  reactions   FeedReaction[]

  @@map("feed_posts")
}

model FeedComment {
  id        String   @id @default(uuid())
  
  // Polymorphic Relations (Only one should be set)
  postId    String?
  post      FeedPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  memoryCapsuleId String?
  memoryCapsule   MemoryCapsule? @relation(fields: [memoryCapsuleId], references: [id], onDelete: Cascade)
  
  legacyWallItemId String?
  legacyWallItem   LegacyWallItem? @relation(fields: [legacyWallItemId], references: [id], onDelete: Cascade)
  
  traditionId     String?
  tradition       Tradition? @relation(fields: [traditionId], references: [id], onDelete: Cascade)

  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("feed_comments")
}

model FeedReaction {
  id        String   @id @default(uuid())
  
  // Polymorphic Relations
  postId    String?
  post      FeedPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  memoryCapsuleId String?
  memoryCapsule   MemoryCapsule? @relation(fields: [memoryCapsuleId], references: [id], onDelete: Cascade)
  
  legacyWallItemId String?
  legacyWallItem   LegacyWallItem? @relation(fields: [legacyWallItemId], references: [id], onDelete: Cascade)
  
  traditionId     String?
  tradition       Tradition? @relation(fields: [traditionId], references: [id], onDelete: Cascade)

  profileId String
  type      String   // like, love, etc.
  createdAt DateTime @default(now())

  // Ensure unique reaction per user per item
  @@unique([postId, profileId])
  @@unique([memoryCapsuleId, profileId])
  @@unique([legacyWallItemId, profileId])
  @@unique([traditionId, profileId])
  
  @@map("feed_reactions")
}

model MediaItem {
  id          String   @id @default(uuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  url         String
  type        MediaType
  title       String?
  description String?
  tags        String[] @default([])
  
  // Relations to other items (Optional, as media can belong to creating things)
  memoryCapsuleId String?
  memoryCapsule   MemoryCapsule? @relation(fields: [memoryCapsuleId], references: [id])
  
  legacyWallItemId String?
  legacyWallItem   LegacyWallItem? @relation(fields: [legacyWallItemId], references: [id])
  
  traditionId     String?
  tradition       Tradition? @relation(fields: [traditionId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("media_items")
}

model ChatConversation {
  id        String   @id @default(uuid())
  user1Id   String
  user1     Profile  @relation("User1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2Id   String
  user2     Profile  @relation("User2", fields: [user2Id], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  ChatMessage[]

  @@unique([user1Id, user2Id])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         Profile          @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  content        String
  read           Boolean          @default(false)
  createdAt      DateTime         @default(now())

  @@map("chat_messages")
}

model Notification {
  id        String           @id @default(uuid())
  profileId String
  profile   Profile          @relation(fields: [profileId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  @@map("notifications")
}

model StoryPrompt {
  id       String   @id @default(uuid())
  question String
  category String?
  active   Boolean  @default(true)
  createdAt DateTime @default(now())

  @@map("story_prompts")
}
